CREATE DATABASE JOINT 

--Alunos (MAT, nome, endereço, cidade)
CREATE TABLE ALUNO(
CODALUNO SERIAL PRIMARY KEY,
NOMEALUNO VARCHAR(80) NOT NULL,
ENDERECO VARCHAR (120) NOT NULL,
CIDADE VARCHAR(120) NOT NULL 
);
DROP CONSTRAINT CIDADE;
INSERT INTO ALUNO(CODALUNO,NOMEALUNO,ENDERECO,CIDADE) VALUES(2015010101,'JOSE DE ALENCAR', 'RUA DAS ALMAS', 'NATAL')
INSERT INTO ALUNO(CODALUNO,NOMEALUNO,ENDERECO,CIDADE) VALUES(2015010102, 'JOÃO JOSÉ', 'AVENIDA RUY CARNEIRO', 'JOÃO PESSOA') 
INSERT INTO ALUNO(CODALUNO,NOMEALUNO,ENDERECO,CIDADE) VALUES(2015010103, 'MARIA JOAQUINA', 'RUA CARROSSEL', 'RECIFE')
INSERT INTO ALUNO(CODALUNO,NOMEALUNO,ENDERECO,CIDADE) VALUES(2015010104, 'MARIA DAS DORES', 'RUA DAS LADEIRAS', 'FORTALEZA')
INSERT INTO ALUNO(CODALUNO,NOMEALUNO,ENDERECO,CIDADE) VALUES(2015010105, 'JOSUÉ CLAUDINO DOS SANTOS', 'CENTRO', 'NATAL')
INSERT INTO ALUNO(CODALUNO,NOMEALUNO,ENDERECO,CIDADE) VALUES(2015010106, 'JOSUÉLISSON CLAUDINO DOS SANTOS', 'CENTRO', 'NATAL') 

--Disciplinas (COD_DISC, nome_disc, carga_hor)
CREATE TABLE DISCIPLINAS(
CODDISC VARCHAR(10) PRIMARY KEY,
NOMEDISC VARCHAR(120) NOT NULL UNIQUE,
CARGAHOR VARCHAR(15) NOT NULL
);
SELECT * FROM DISCIPLINAS
INSERT INTO DISCIPLINAS(CODDISC,NOMEDISC,CARGAHOR) VALUES('BD','BANCO DE DADOS', '100') 
INSERT INTO DISCIPLINAS(CODDISC,NOMEDISC,CARGAHOR) VALUES('POO','PROGRAMAÇÃO COM ACESSO A BANCO DE DADOS', '100')
INSERT INTO DISCIPLINAS(CODDISC,NOMEDISC,CARGAHOR) VALUES('WEB','AUTORIA WEB', '50')  
INSERT INTO DISCIPLINAS(CODDISC,NOMEDISC,CARGAHOR) VALUES('ENG','ENGENHARIA DE SOFTWARE', '80') 
SELECT * FROM DISCIPLINAS
--Professores (COD_PROF, nome, endereço, cidade)
CREATE TABLE PROFESSORES(
CODPROF SERIAL PRIMARY KEY,
NOMEPROF VARCHAR(80) NOT NULL,
ENDERECO VARCHAR(120) NOT NULL,
CIDADE VARCHAR(120) NOT NULL 
);
INSERT INTO PROFESSORES(CODPROF,NOMEPROF,ENDERECO,CIDADE) VALUES(212131, 'NICKERSON FERREIRA', 'RUA MANAÍRA', 'JOÃO PESSOA')
INSERT INTO PROFESSORES(CODPROF,NOMEPROF,ENDERECO,CIDADE) VALUES(122135, 'ADORILSON BEZERRA', 'AVENIDA SALGADO FILHO', 'NATAL')
INSERT INTO PROFESSORES(CODPROF,NOMEPROF,ENDERECO,CIDADE) VALUES(192011, 'DIEGO OLIVEIRA', 'AVENIDA ROBERTO FREIRE', 'NATAL') 

/*Turma (COD_DISC, COD_TURMA, COD_PROF, ANO, horário)
 COD_DISC referencia Disciplinas
 COD_PROF referencia Professores*/
CREATE TABLE TURMA(
CODTURMA SERIAL PRIMARY KEY, 	 
CODDISC_FK VARCHAR REFERENCES DISCIPLINAS(CODDISC),
CODPROF_FK INTEGER REFERENCES PROFESSORES(CODPROF),
ANO CHAR(15) NOT NULL,
HORARIO CHAR(15) NOT NULL
);
INSERT INTO TURMA(CODTURMA,CODDISC_FK,CODPROF_FK,ANO,HORARIO) VALUES(1,'BD',212131,2015, '11H-12H')
INSERT INTO TURMA(CODTURMA,CODDISC_FK,CODPROF_FK,ANO,HORARIO) VALUES(2,'BD',212131,2015, '13H-14H')
INSERT INTO TURMA(CODTURMA,CODDISC_FK,CODPROF_FK,ANO,HORARIO) VALUES(3,'POO',192011,2015, '08H-09H')
INSERT INTO TURMA(CODTURMA,CODDISC_FK,CODPROF_FK,ANO,HORARIO) VALUES(4,'ENG',192011,2015, '07H-08H')
INSERT INTO TURMA(CODTURMA,CODDISC_FK,CODPROF_FK,ANO,HORARIO) VALUES(5,'ENG',212131,2015, '10H-11H')
SELECT * FROM TURMA
SELECT * FROM DISCIPLINAS

/*Histórico (MAT, COD_DISC, COD_TURMA, COD_PROF, ANO, frequência, nota)
MAT referencia Alunos
COD_DISC, COD_TURMA, COD_PROF, ANO referencia Turma*/
CREATE TABLE HISTORICO(
CODALUNO_FK INTEGER REFERENCES ALUNO(CODALUNO),
CODDISC_FK VARCHAR REFERENCES DISCIPLINAS(CODDISC),
CODTURMA_FK INTEGER REFERENCES TURMA(CODTURMA),
CODPROF_FK INTEGER REFERENCES PROFESSORES(CODPROF),
ANO CHAR(5) NOT NULL,
FREQUENCIA NUMERIC(10,2) NOT NULL,
NOTA NUMERIC(10,2) NOT NULL
);

INSERT INTO HISTORICO(CODALUNO_FK,CODDISC_FK,CODTURMA_FK,CODPROF_FK,ANO,FREQUENCIA,NOTA) VALUES(2015010101, 'BD', 1, 212131, '2015', '66.76','3')
INSERT INTO HISTORICO(CODALUNO_FK,CODDISC_FK,CODTURMA_FK,CODPROF_FK,ANO,FREQUENCIA,NOTA) VALUES(2015010102, 'BD', 2, 212131, '2015', '46.44','4')
INSERT INTO HISTORICO(CODALUNO_FK,CODDISC_FK,CODTURMA_FK,CODPROF_FK,ANO,FREQUENCIA,NOTA) VALUES(2015010103, 'POO', 3, 192011, '2015', '78.88','8')  
INSERT INTO HISTORICO(CODALUNO_FK,CODDISC_FK,CODTURMA_FK,CODPROF_FK,ANO,FREQUENCIA,NOTA) VALUES(2015010104, 'WEB', 4, 192011, '2015', '98.11','9') 
INSERT INTO HISTORICO(CODALUNO_FK,CODDISC_FK,CODTURMA_FK,CODPROF_FK,ANO,FREQUENCIA,NOTA) VALUES(2015010105, 'ENG', 5, 122135, '2015', '100.00','10')
SELECT * FROM PROFESSORES
SELECT * FROM ALUNO
SELECT * FROM DISCIPLINAS
SELECT * FROM HISTORICO

/*a) Encontre a MAT dos alunos com nota em BD em 2015 menor que 5 (obs: BD =
código da disciplinas).*/
CREATE OR REPLACE VIEW EXA AS SELECT CODALUNO_FK,NOTA,CODDISC_FK,ANO FROM
HISTORICO
WHERE NOTA < (5)
AND ANO = ('2015') 
AND CODDISC_FK  = 'BD';

SELECT * FROM EXA

/*b) Encontre a MAT e calcule a média das notas dos alunos na disciplina de POO
em 2015.*/

CREATE OR REPLACE VIEW AAA AS SELECT NOTA,CODDISC_FK,ANO FROM
HISTORICO
WHERE ANO = ('2015')
AND CODDISC_FK  = 'POO';

SELECT * FROM AAA;

/*c) Encontre a MAT e calcule a média das notas dos alunos na disciplina de POO
em 2015 e que esta média seja superior a 6.*/

CREATE OR REPLACE FUNCTION NOTAPOO(NOTA NUMERIC) RETURNS HISTORICO AS
$$
	BEGIN
	 SELECT * FROM HISTORICO WHERE NOTA < 6;
	END;
$$LANGUAGE plpgsql;

SELECT * FROM NOTAPOO;

